name: Firebase Deploy

on:
  push:
    branches:
      - master
      - main
      - dev
      - development
      - '*' # Allow any branch
  pull_request:
    branches:
      - master
      - main

jobs:
  build_and_deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: 18

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7.33.7
          # Don't run install here

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Determine environment
        id: determine_env
        run: |
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/master" || "${{ github.ref }}" == "refs/heads/main") ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "Using PRODUCTION environment"
            echo "envkeys=PROD_envKeys" >> $GITHUB_OUTPUT
            echo "service_account=PROD_FIREBASE_SERVICE_ACCOUNT" >> $GITHUB_OUTPUT
            echo "project_id=${{ secrets.PROD_FIREBASE_PROJECT_ID }}" >> $GITHUB_ENV
            echo "recaptcha_site_key=${{ secrets.PROD_RECAPTCHA_SITE_KEY }}" >> $GITHUB_ENV
            echo "recaptcha_secret_key=${{ secrets.PROD_RECAPTCHA_SECRET_KEY }}" >> $GITHUB_ENV
            echo "firebase_min_instances=${{ vars.PROD_FIREBASE_FUNCTION_MIN_INSTANCES || '1' }}" >> $GITHUB_ENV
            echo "firebase_max_instances=${{ vars.PROD_FIREBASE_FUNCTION_MAX_INSTANCES || '10' }}" >> $GITHUB_ENV
            echo "firebase_memory=${{ vars.PROD_FIREBASE_FUNCTION_MEMORY || '1GB' }}" >> $GITHUB_ENV
            echo "firebase_cpu=${{ vars.PROD_FIREBASE_FUNCTION_CPU || '1' }}" >> $GITHUB_ENV
            echo "firebase_timeout=${{ vars.PROD_FIREBASE_FUNCTION_TIMEOUT || '60' }}" >> $GITHUB_ENV
            echo "firebase_concurrency=${{ vars.PROD_FIREBASE_FUNCTION_CONCURRENCY || '80' }}" >> $GITHUB_ENV
            echo "FIREBASE_REGION=us-central1" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=development" >> $GITHUB_ENV
            echo "Using DEVELOPMENT environment"
            echo "envkeys=DEV_envKeys" >> $GITHUB_OUTPUT
            echo "service_account=DEV_FIREBASE_SERVICE_ACCOUNT" >> $GITHUB_OUTPUT
            echo "project_id=${{ secrets.DEV_FIREBASE_PROJECT_ID }}" >> $GITHUB_ENV
            echo "recaptcha_site_key=${{ secrets.DEV_RECAPTCHA_SITE_KEY }}" >> $GITHUB_ENV
            echo "recaptcha_secret_key=${{ secrets.DEV_RECAPTCHA_SECRET_KEY }}" >> $GITHUB_ENV
            echo "firebase_min_instances=${{ vars.DEV_FIREBASE_FUNCTION_MIN_INSTANCES || '0' }}" >> $GITHUB_ENV
            echo "firebase_max_instances=${{ vars.DEV_FIREBASE_FUNCTION_MAX_INSTANCES || '5' }}" >> $GITHUB_ENV
            echo "firebase_memory=${{ vars.DEV_FIREBASE_FUNCTION_MEMORY || '512MB' }}" >> $GITHUB_ENV
            echo "firebase_cpu=${{ vars.DEV_FIREBASE_FUNCTION_CPU || '1' }}" >> $GITHUB_ENV
            echo "firebase_timeout=${{ vars.DEV_FIREBASE_FUNCTION_TIMEOUT || '60' }}" >> $GITHUB_ENV
            echo "firebase_concurrency=${{ vars.DEV_FIREBASE_FUNCTION_CONCURRENCY || '80' }}" >> $GITHUB_ENV
            echo "FIREBASE_REGION=us-central1" >> $GITHUB_ENV
          fi

      - name: Setup Firebase service account
        run: |
          # Ensure jq is installed (for JSON validation)
          sudo apt-get update -y && sudo apt-get install -y jq

          # Write service account JSON to file using jq for proper formatting
          echo '${{ secrets[steps.determine_env.outputs.service_account] }}' | jq . > service-account.json

          # Validate the JSON syntax
          jq empty service-account.json || { echo "Invalid JSON in service account file"; exit 1; }

          # Verify key fields exist in service account file
          if ! jq -e '.project_id' service-account.json > /dev/null; then
            echo "Error: service account JSON missing project_id field"
            exit 1
          fi
          if ! jq -e '.client_email' service-account.json > /dev/null; then
            echo "Error: service account JSON missing client_email field"
            exit 1
          fi
          if ! jq -e '.private_key' service-account.json > /dev/null; then
            echo "Error: service account JSON missing private_key field"
            exit 1
          fi

          # Set absolute path to service account file as environment variable
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/service-account.json" >> $GITHUB_ENV

          # Also set a flag so code knows we're in CI environment
          echo "CI=true" >> $GITHUB_ENV

          # Add the project root to NODE_PATH so imports work correctly
          echo "NODE_PATH=$(pwd)" >> $GITHUB_ENV

          echo "Service account validated and GOOGLE_APPLICATION_CREDENTIALS set to $(pwd)/service-account.json"

      - name: Set environment variables
        run: |
          # Decode environment variables from GitHub secret and write to .env file
          echo "${{ secrets[steps.determine_env.outputs.envkeys] }}" | base64 --decode > .env
          echo "Created environment file from ${{ steps.determine_env.outputs.envkeys }}"

          # Add additional required environment variables
          echo "NUXT_PUBLIC_RECAPTCHA_SITE_KEY=$recaptcha_site_key" >> .env
          echo "NUXT_RECAPTCHA_SECRET_KEY=$recaptcha_secret_key" >> .env

          # Add Firebase function configuration
          echo "FIREBASE_FUNCTION_MIN_INSTANCES=$firebase_min_instances" >> .env
          echo "FIREBASE_FUNCTION_MAX_INSTANCES=$firebase_max_instances" >> .env
          echo "FIREBASE_FUNCTION_MEMORY=$firebase_memory" >> .env
          echo "FIREBASE_FUNCTION_CPU=$firebase_cpu" >> .env
          echo "FIREBASE_FUNCTION_TIMEOUT=$firebase_timeout" >> .env
          echo "FIREBASE_FUNCTION_CONCURRENCY=$firebase_concurrency" >> .env

          # For troubleshooting - Print environment file without sensitive values
          echo "Environment file created with the following keys:"
          grep -v "KEY\|SECRET\|PASSWORD\|TOKEN" .env | sed 's/=.*/=***/' || echo "No non-sensitive keys found"

      - name: Setup FontAwesome
        run: |
          # Configure npm for FontAwesome authenticated access
          echo "@awesome.me:registry=https://npm.fontawesome.com/" > .npmrc
          echo "@fortawesome:registry=https://npm.fontawesome.com/" >> .npmrc
          echo "//npm.fontawesome.com/:_authToken=${{ secrets.FONTAWESOME_TOKEN }}" >> .npmrc

          # Debug - Verify .npmrc content (without showing token)
          echo "Verifying .npmrc configuration:"
          cat .npmrc | sed 's/_authToken=.*/_authToken=***HIDDEN***/' || echo ".npmrc not found!"
          echo "File permissions on .npmrc:"
          ls -la .npmrc || echo "File not found"

          # Ensure .npmrc is in the home directory as well (to catch alternate lookup paths)
          echo "@awesome.me:registry=https://npm.fontawesome.com/" > ~/.npmrc
          echo "@fortawesome:registry=https://npm.fontawesome.com/" >> ~/.npmrc
          echo "//npm.fontawesome.com/:_authToken=${{ secrets.FONTAWESOME_TOKEN }}" >> ~/.npmrc

          # Configure PNPM directly with the command-line tool
          # This ensures the settings are applied regardless of config file location
          pnpm config set @awesome.me:registry https://npm.fontawesome.com/
          pnpm config set @fortawesome:registry https://npm.fontawesome.com/
          pnpm config set //npm.fontawesome.com/:_authToken ${{ secrets.FONTAWESOME_TOKEN }}

          # Verify PNPM configuration
          echo "PNPM configuration verification:"
          pnpm config get @fortawesome:registry || echo "PNPM config not set properly"

          echo "Created FontAwesome npm configuration in all relevant locations"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install FontAwesome packages explicitly
        run: |
          # Sometimes installing FontAwesome packages separately helps with authentication issues
          echo "Installing FontAwesome packages separately..."
          pnpm add @fortawesome/fontawesome-free || echo "Could not install @fortawesome/fontawesome-free"
          echo "FontAwesome installation step complete"

      - name: Run linting
        run: pnpm lint || echo "Linting issues found - review output"

      - name: Install vue-recaptcha-v3 if needed
        run: pnpm add vue-recaptcha-v3 || echo "Vue-recaptcha-v3 already installed"

      - name: Build application
        run: |
          # Set deployment environment variables
          export DEPLOY_ENV=$ENVIRONMENT
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/service-account.json"
          export NITRO_PRESET=firebase
          export NUXT_PUBLIC_RECAPTCHA_SITE_KEY=$recaptcha_site_key
          export NUXT_RECAPTCHA_SECRET_KEY=$recaptcha_secret_key

          # Export Firebase function configuration
          export FIREBASE_FUNCTION_MIN_INSTANCES=$firebase_min_instances
          export FIREBASE_FUNCTION_MAX_INSTANCES=$firebase_max_instances
          export FIREBASE_FUNCTION_MEMORY=$firebase_memory
          export FIREBASE_FUNCTION_CPU=$firebase_cpu
          export FIREBASE_FUNCTION_TIMEOUT=$firebase_timeout
          export FIREBASE_FUNCTION_CONCURRENCY=$firebase_concurrency

          # Force Node.js 18
          export NODE_VERSION=18
          echo "Building for $ENVIRONMENT environment with Firebase preset using Node.js 18"
          pnpm build
        env:
          # Use Firebase preset for Nitro
          NITRO_PRESET: firebase

      - name: Run tests (if available)
        run: pnpm test || echo "No tests found or tests failed"
        continue-on-error: true

      - name: Prepare Firebase Functions
        run: |
          echo "Preparing Firebase Functions..."
          cd functions

          # Install dependencies for Firebase Functions
          pnpm install

          # Build TypeScript code
          pnpm build

          # List compiled files to verify build
          echo "Compiled function files:"
          ls -la lib/ || echo "No compiled files found - check for build errors"

          cd ..
          echo "Firebase Functions preparation complete"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@13.0.2
        # Using v13.0.2 which is the latest version compatible with Node.js 18

      - name: Deploy to Firebase
        if: github.event_name == 'push'
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/service-account.json"

          # Extract service account details for debugging
          PROJECT_ID=$(jq -r '.project_id' service-account.json)
          CLIENT_EMAIL=$(jq -r '.client_email' service-account.json)
          echo "Service account project: $PROJECT_ID"
          echo "Service account email: $CLIENT_EMAIL"

          # Using the service account credentials directly
          echo "Deploying to Firebase project: $project_id"
          firebase use $project_id --non-interactive

          # Create a package.json in the functions directory with firebase-functions dependency
          if [ -d "functions" ]; then
            echo "Preparing functions for Firebase deployment..."
            # Now explicitly install the dependencies in the output directory
            echo "Installing dependencies in functions directory..."
            cd functions
            # Install directory
            pnpm install
            cd ..
            echo "Dependencies installed in functions"
          else
            echo "Warning: functions directory not found. Nuxt build may have failed."
          fi

          # Display function configuration being deployed
          echo "Function configuration:"
          echo "  Min instances: $firebase_min_instances"
          echo "  Max instances: $firebase_max_instances"
          echo "  Memory: $firebase_memory"
          echo "  CPU: $firebase_cpu"
          echo "  Timeout: $firebase_timeout s"
          echo "  Concurrency: $firebase_concurrency"

          # Deploy each component separately to isolate any issues
          echo "Deploying Firestore rules and indexes..."
          firebase deploy --only firestore --project $project_id --non-interactive || echo "Firestore rules deployment failed, will try to continue with the rest"

          echo "Deploying Storage rules..."
          firebase deploy --only storage --project $project_id --non-interactive || echo "Storage rules deployment failed, will try to continue with the rest"

          echo "Deploying hosting..."
          firebase deploy --only hosting --project $project_id --non-interactive || echo "Hosting deployment failed, will try to continue with functions"

          echo "Deploying functions..."
          firebase deploy --only functions:server --project $project_id --non-interactive
